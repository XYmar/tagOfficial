<!DOCTYPE html>


<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>结果提交</title>

    <!--<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.8.1/build/reset/reset-min.css"/>-->
    <link href="../bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="../fonts/font-awesome/css/font-awesome.css" rel="stylesheet">
    <link href="apply.css" rel="stylesheet">
    <link rel="stylesheet" href="../bootstrap-table/bootstrap-table.min.css">
    <!--<link rel="stylesheet" type="text/css" href="../css/style.min.css">-->
    <link rel="stylesheet" href="../css/header2.css" type="text/css" />
    <link rel="stylesheet" href="../css/fileUpload.css">
    <link rel="stylesheet" href="../bootstrap-table/bootstrap-table.min.css">
    <link rel="stylesheet" type="text/css" href="../css/applyInfo2.css">

    <link rel="stylesheet" type="text/css" href="../css/buttons.css"/>
    <link rel="stylesheet" type="text/css" href="../css/resultFinal.css"/>
    <!--<link href="apply.css" rel="stylesheet" type="text/css" />-->

    <style type="text/css">

        /*html {
            background-color: #ddd;
            font: 62.5%/1 "Lucida Sans Unicode","Lucida Grande",Verdana,Arial,Helvetica,sans-serif;
        }*/
        body {
            padding: 20px 60px;
        }
        .bgimg{
            position: fixed;
            left:0px;
            top:0px;
            margin:auto;
            width:100%;
            height:100%;
            z-index:-1000;
        }
        .cover{
            position: fixed;
            left:0px;
            top:0px;
            z-index: -900;
            opacity: 0.8;
            height: 100%;
            width: 100%;
            background: black;
        }
        #wrapper { text-align: center; }


        /*It appears that the Pictos Font resets the line-height of the icon.. so if you are using them, delete the line below. */
        .icon:before { line-height: .7em; }

    </style>


</head>

<body>
<img src="../images/adminBg2.png" alt="" width='100%' height='100%' class="bgimg">
<header class="header fixed clearfix navbar navbar-fixed-top">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="header-left">
                    <div class="logo smooth-scroll">
                        <a href="../indexFinal.html"><img id="logo" src="../images/logo2.png" alt="Worthy"></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
<div class="container-fluid" style="height: 90%;">
    <div class="row">
        <div class="col-md-12">
            <div class="row">
                <div class="col-md-12">
                    <h2 class="text-center" id="commitTitle" style="font-size: 40px;color:#ffc400">
                    </h2>
                </div>
            </div>
            <div class="row containerRow">
                <div class="col-md-12 childToTop">
                    <div class="col-md-1" style="padding: 0">
                    </div>
                    <!-- tab页 -->
                    <div class="col-md-10">
                        <!-- 成绩信息 -->
                        <div class="row-fluid col-md-12 memChildToTop">
                            <div class="col-md-2" style="padding: 0">
                                <h4 class="title">
                                    成绩信息
                                </h4>
                            </div>
                            <div class="col-md-10 group-info">
                                <div class="col-md-6">
                                    <form class="form-horizontal col-md-12">
                                        <div class="form-group col-md-12">
                                            <label class="col-md-4 col-xs-3 memLabel">ROUGE-L： </label>
                                            <div class="controls col-md-8 col-xs-9 memInput">
                                                <div id="rouge">
                                                    xx
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="col-md-6">
                                    <form class="form-horizontal col-md-12">
                                        <div class="form-group col-md-12">
                                            <label class="col-md-4 col-xs-3 memLabel">BLEU-4： </label>
                                            <div class="controls col-md-8 col-xs-9 memInput">
                                                <div id="bleu">
                                                    xx
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>

                            </div>
                        </div>

                        <!-- 结果提交 -->
                        <div class="row-fluid col-md-12 col-sm-12" style="border-bottom: 0;">
                            <div class="col-md-2 col-sm-12 col-xs-12 titleInfo" style="padding: 0">
                                <h4 class="title">
                                    结果提交
                                </h4>
                            </div>
                            <div class="col-md-10 group-info">
                                <div class="identifyContainer">

                                    <div class="col-md-10">
                                        <h4 class="sign" id="warning">
                                        </h4>
                                    </div>
                                    <div class="col-md-12">
                                        <form class="form-horizontal" enctype="multipart/form-data">
                                            <div style="padding: 0" id="Lpicture">
                                                <h3 style="    font-size: 14px; font-weight: bold;"><span class="required-flag">*</span>文件：</h3>
                                                <div class="fileArea" id="file1" style="padding-top:5px;">
                                                </div>
                                                <div class="col-md-2 idPic">
                                                            <span class="btn btn-info btn-small fileinput-button" style="padding: 4px 10px;font-size: 12px;">
                                                                <i class="glyphicon glyphicon-plus"></i>
                                                                <span>上传附件</span>
                                                                <input class="chooseFile disableAll" type="file" name="diploma" id="file1Cont" accept="application/json"/>
                                                            </span>
                                                </div>
                                                <div class="col-md-5 modifyPasBtnCon">
                                                    <div class="col-md-12">
                                                        <button type="button" class="btn  btn-success" id="ifSub" style="width: 70px;height: 27px;font-size: 12px;padding: 4px 0;" onclick="subFiles()">提交</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>

                                </div>
                            </div>

                        </div>

                        <!-- 历史信息 -->
                        <div class="row-fluid col-md-12" style="overflow: hidden;">
                            <div class="col-md-2" style="padding: 0">
                                <h4 class="title">
                                    历史成绩
                                </h4>
                            </div>

                            <!-- 成绩表格 -->
                            <div class="col-md-10 group-info" style="padding: 10px 10px;">
                                <div>
                                    <table id="trainingScoreInfoTable">
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div>
                    <!-- tab页结束 -->


                    <br/>
                </div>
            </div>
            <br>
            <br>
        </div>
    </div>

</div>

<!--<div id="wrapper">


</div>-->

<div style="text-align:center;clear:both;">
    <!-- JavaScript -->
    <script src="../js/jquery-3.3.1.js"></script>
    <script type="text/javascript" src="../bootstrap/js/bootstrap.min.js"></script>

    <script src="../js/jquery.cookie.js"></script>
    <script type="text/javascript" src="../js/jquery.base64.js"></script>
    <script src="../js/globalIP.js"></script>

    <script src="../bootstrap-table/bootstrap-table.min.js"></script>
    <script src="../bootstrap-table/bootstrap-table-zh-CN.min.js"></script>

    <script src="../layer/layer.js"></script>
</div>
<script>
    let myTeamId = $.cookie("myTeamId");
    let username = $.cookie("myUsername");
    let password0 = $.cookie("myWPa");
    let password = $.base64.decode(password0);
    let token = username + ':' + password;
    let id = getUrlParam('id');
    let id2 = Number(id) + 2;

    window.onload = function () {
        //禁用Enter
        $(window).keydown( function(e) {
            const key = window.event?e.keyCode:e.which;
            if(key.toString() == "13"){
                return false;
            }
        });

        //根据不同阶段显示不同标题
        if(id === "1"){
            document.getElementById("commitTitle").innerHTML = "军事新闻提交"

            getHisScore1();
        }else if(id === "2"){
            document.getElementById("commitTitle").innerHTML = "防务快讯提交"

            getHisScore2();
        }else if(id === "3"){
            document.getElementById("commitTitle").innerHTML = "非密情报提交"

            getHisScore3();
        }
        resetAll();


        //添加文件
        let file1 = document.getElementById("file1Cont");
        file1.onchange = function(){
            if(file1.value.length !== 0){
                let file = this.files[0];
                let divId = "file1";
                handleFile(file, divId);
            }
        }
    }

    function handleFile(file, divId){
        //获取文件名称
        let fileName = file.name;
        url=window.URL.createObjectURL(file);
        //清空文件列表
        let fileArea = document.getElementById(divId);
        fileArea.innerHTML = '';
        //添加到文件列表
        let html = '<div class="col-md-12 idPic">' +
            '<p class="fileName col-md-5 col-xs-12 idPic">' + fileName + '</p>' +
            '<div class="col-md-1 col-xs-3 idPic"><span class="delFile btn btn-danger btn-mini disableAll newAddFile" onclick="delFile(event)"' +
            ' style="cursor:pointer;padding: 3px 8px;font-size: 11px;border-radius: 3px;">删除</span></div>' +
            '</div>';

        let $fileArea = document.getElementById(divId);
        $(html).appendTo($fileArea);
    }

    function delFile(event){
        let e = event || window.event;
        let target = e.target || e.srcElement;
        let delDiv = target.parentNode.parentNode;
        let id1 = delDiv.parentNode.id;
        let $fileArea = document.getElementById(id1);
        $fileArea.removeChild(delDiv);
        let fileCont = document.getElementById("file1Cont");
        fileCont.value = '';
    }

    function resetAll() {
        $.ajax({
            type: "GET",
            dataType: "json",
            url: IpAll() + "users/" + myTeamId,
            beforeSend: function (xhr) {
                xhr.setRequestHeader('Authorization', 'Basic ' + btoa(token));
            },
            success: function (result) {
                let data = result.data;

                if(id === "1"){
                    document.getElementById('bleu').innerHTML = data.bleu4ScoreF1.toFixed(2) + "%";
                    document.getElementById('rouge').innerHTML = data.rougelScoreF1.toFixed(2) + "%";
                    document.getElementById("warning").innerHTML = "注意：只可以提交JSON文件，今日还可提交 " + data.commitTimesF1 + " 次"
                    if(data.commitTimesF1 === 0){
                        document.getElementById("ifSub").disabled = true;
                    }
                }else if(id === "2"){
                    document.getElementById('bleu').innerHTML = data.bleu4ScoreF2.toFixed(2) + "%";
                    document.getElementById('rouge').innerHTML = data.rougelScoreF2.toFixed(2) + "%";
                    document.getElementById("warning").innerHTML = "注意：只可以提交JSON文件，今日还可提交 " + data.commitTimesF2 + " 次"

                    if(data.commitTimesF2 === 0){
                        document.getElementById("ifSub").disabled = true;
                    }
                }else if(id === "3"){
                    document.getElementById('bleu').innerHTML = data.bleu4ScoreF3.toFixed(2) + "%";
                    document.getElementById('rouge').innerHTML = data.rougelScoreF3.toFixed(2) + "%";
                    document.getElementById("warning").innerHTML = "注意：只可以提交JSON文件，今日还可提交 " + data.commitTimesF3 + " 次"
                    if(data.commitTimesF3 === 0){
                        document.getElementById("ifSub").disabled = true;
                    }
                }


            },
            error: function (error) {
                let notifyMessage = error.responseJSON.message
                alert(notifyMessage)
            }
        });
    }

    function subFiles() {
        let file1 = document.getElementById("file1Cont").files[0];  //获取文件
        //console.log(file1);
        if(typeof (file1) !== "undefined"){
            let formData = new FormData();
            formData.append("ref", file1);
            formData.append("type", id);
            layer.msg('正在提交...', {
                icon: 16,
                shade: 0.01,
                time: false //取消自动关闭
            });
            $.ajax({
                url: IpAll() + "finals/" + myTeamId + "/commit-file",
                data: formData,
                type: "POST",
                async: true,
                dataType: "json",
                cache: false,
                processData: false,
                contentType: false,
                enctype: 'multipart/form-data',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('Authorization', 'Basic ' + btoa(token));
                },
                timeout : 120000,
                success: function (result) {
                    layer.alert('提交成功', {
                        closeBtn: 0,    // 是否显示关闭按钮
                        anim: 0,//动画类型
                        btn: ['确定'],//按钮
                        icon: 6,    // icon
                        yes:function(){
                            layer.closeAll();
                            resetAll();
                            if(id === "1"){
                                getHisScore1();
                            }else if(id === "2"){
                                getHisScore2();
                            }else if(id === "3"){
                                getHisScore3();
                            }

                        }});
                },
                error : function(error) {
                    layer.closeAll();
                    if(error.responseJSON && error.responseJSON.message){
                        let notifyMessage = error.responseJSON.message
                        layer.alert(notifyMessage, {
                            closeBtn: 0,    // 是否显示关闭按钮
                            anim: 0,//动画类型
                            btn: ['确定'],//按钮
                            icon: 5,    // icon
                            yes:function(){
                                layer.closeAll();
                            }});
                    }else{
                        layer.alert('请求超时', {
                            closeBtn: 0,    // 是否显示关闭按钮
                            anim: 0,//动画类型
                            btn: ['确定'],//按钮
                            icon: 5,    // icon
                            yes:function(){
                                layer.closeAll();
                            }});
                    }
                }
            });
        }else {
            alert("请先选择文件");
        }

    }

    //历史成绩  第一轮
    function getHisScore1(){
        let myTeamId = $.cookie("myTeamId");
        $.ajax({
            type: "GET",
            dataType: "json",
            data: { type: 3 },
            url: IpAll() + "users/" + myTeamId + "/scorelogsbytype" ,
            beforeSend: function (xhr) {
                xhr.setRequestHeader('Authorization', 'Basic ' + btoa(token));
            },
            success: function (result) {
                let str = "";
                let data = result.data;
                console.log(data[0].rougelScoreF1)
                $("#trainingScoreInfoTable").bootstrapTable('destroy');
                $('#trainingScoreInfoTable').bootstrapTable({
                    sidePagination : "client", // 分页方式：client客户端分页，server服务端分页（*）
                    pagination : true, // 是否显示分页（*）
                    pageNumber: 1,    //如果设置了分页，首页页码
                    pageSize: 10,                       //每页的记录行数（*）
                    pageList: [10,20,30],        //可供选择的每页的行数（*）
                    search:true,
                    columns: [{
                        field: 'rouge_Score',
                        title: 'ROUGE-L',
                        formatter: precentFormatter
                    }, {
                        field: 'bleu_4_Score',
                        title: 'BLEU-4',
                        formatter: precentFormatter
                    }, {
                        field: 'createTime',
                        title: '提交日期',
                        sortable: true
                    }
                    ],
                    data: data
                });

            },
            error : function(error) {
                let notifyMessage = error.responseJSON.message
                alert(notifyMessage)
            }
        });
    }

    //历史成绩  第二轮
    function getHisScore2(){
        let myTeamId = $.cookie("myTeamId");
        $.ajax({
            type: "GET",
            dataType: "json",
            data: { type: 4 },
            url: IpAll() + "users/" + myTeamId + "/scorelogsbytype" ,
            beforeSend: function (xhr) {
                xhr.setRequestHeader('Authorization', 'Basic ' + btoa(token));
            },
            success: function (result) {
                let str = "";
                let data = result.data;
                $("#trainingScoreInfoTable").bootstrapTable('destroy');
                $('#trainingScoreInfoTable').bootstrapTable({
                    sidePagination : "client", // 分页方式：client客户端分页，server服务端分页（*）
                    pagination : true, // 是否显示分页（*）
                    pageNumber: 1,    //如果设置了分页，首页页码
                    pageSize: 10,                       //每页的记录行数（*）
                    pageList: [10,20,30],        //可供选择的每页的行数（*）
                    search:true,
                    columns: [{
                        field: 'rouge_Score',
                        title: 'ROUGE-L',
                        formatter: precentFormatter
                    }, {
                        field: 'bleu_4_Score',
                        title: 'BLEU-4',
                        formatter: precentFormatter
                    }, {
                        field: 'createTime',
                        title: '提交日期',
                        sortable: true
                    }
                    ],
                    data: data
                });

            },
            error : function(error) {
                let notifyMessage = error.responseJSON.message
                alert(notifyMessage)
            }
        });
    }

    //历史成绩  第三轮
    function getHisScore3(){
        let myTeamId = $.cookie("myTeamId");
        $.ajax({
            type: "GET",
            dataType: "json",
            data: { type: 5 },
            url: IpAll() + "users/" + myTeamId + "/scorelogsbytype" ,
            beforeSend: function (xhr) {
                xhr.setRequestHeader('Authorization', 'Basic ' + btoa(token));
            },
            success: function (result) {
                let str = "";
                let data = result.data;
                $("#trainingScoreInfoTable").bootstrapTable('destroy');
                $('#trainingScoreInfoTable').bootstrapTable({
                    sidePagination : "client", // 分页方式：client客户端分页，server服务端分页（*）
                    pagination : true, // 是否显示分页（*）
                    pageNumber: 1,    //如果设置了分页，首页页码
                    pageSize: 10,                       //每页的记录行数（*）
                    pageList: [10,20,30],        //可供选择的每页的行数（*）
                    search:true,
                    columns: [{
                        field: 'rouge_Score',
                        title: 'ROUGE-L',
                        formatter: precentFormatter
                    }, {
                        field: 'bleu_4_Score',
                        title: 'BLEU-4',
                        formatter: precentFormatter
                    }, {
                        field: 'createTime',
                        title: '提交日期',
                        sortable: true
                    }
                    ],
                    data: data
                });

            },
            error : function(error) {
                let notifyMessage = error.responseJSON.message
                alert(notifyMessage)
            }
        });
    }

    //访问静态json数据
    function getPreliminaryScoreScore2() {
        $.ajax({
            type: "GET",
            dataType: "json",
            url: "../files/topTen.json",
            success: function (result) {
                let data = result.data;
                $("#trainingScoreInfoTable").bootstrapTable('destroy');
                $('#trainingScoreInfoTable').bootstrapTable({
                    sidePagination: "client", // 分页方式：client客户端分页，server服务端分页（*）
                    pagination: true, // 是否显示分页（*）
                    pageNumber: 1,    //如果设置了分页，首页页码
                    pageSize: 30,                       //每页的记录行数（*）
                    pageList: [30, 40],        //可供选择的每页的行数（*）
                    search: false,
                    striped: true,
                    columns: [
                        {
                            filed: '',
                            title: '序号',
                            align: "center",
                            width: 40,
                            formatter: linenumber
                        },
                        {
                            field: 'teamName',
                            title: '队伍名称'
                        }, {
                            field: 'rougelScoreP',
                            title: 'ROUGE-L',
                            formatter: precentFormatter
                        }, {
                            field: 'bleu4ScoreP',
                            title: 'BLEU-4',
                            formatter: precentFormatter
                        }, {
                            field: 'commitDateP',
                            title: '提交日期'/*,
                        sortable: true*/
                        }
                    ],
                    data: data
                });

                $("#secondScoreInfoTable").bootstrapTable('destroy');
                $('#secondScoreInfoTable').bootstrapTable({
                    sidePagination: "client", // 分页方式：client客户端分页，server服务端分页（*）
                    pagination: true, // 是否显示分页（*）
                    pageNumber: 1,    //如果设置了分页，首页页码
                    pageSize: 30,                       //每页的记录行数（*）
                    pageList: [30, 40],        //可供选择的每页的行数（*）
                    search: false,
                    striped: true,
                    rowStyle: rowStyle,
                    columns: [
                        {
                            filed: '',
                            title: '序号',
                            align: "center",
                            width: 40,
                            formatter: linenumber
                        },
                        {
                            field: 'teamName',
                            title: '队伍名称'
                        }, {
                            field: 'rougelScoreP',
                            title: 'ROUGE-L',
                            formatter: precentFormatter
                        }, {
                            field: 'bleu4ScoreP',
                            title: 'BLEU-4',
                            formatter: precentFormatter
                        }, {
                            field: 'commitDateP',
                            title: '提交日期'/*,
                        sortable: true*/
                        }
                    ],
                    data: data
                });

                $("#thirdScoreInfoTable").bootstrapTable('destroy');
                $('#thirdScoreInfoTable').bootstrapTable({
                    sidePagination: "client", // 分页方式：client客户端分页，server服务端分页（*）
                    pagination: true, // 是否显示分页（*）
                    pageNumber: 1,    //如果设置了分页，首页页码
                    pageSize: 30,                       //每页的记录行数（*）
                    pageList: [30, 40],        //可供选择的每页的行数（*）
                    search: false,
                    striped: true,
                    rowStyle: rowStyle,
                    columns: [
                        {
                            filed: '',
                            title: '序号',
                            align: "center",
                            width: 40,
                            formatter: linenumber
                        },
                        {
                            field: 'teamName',
                            title: '队伍名称'
                        }, {
                            field: 'rougelScoreP',
                            title: 'ROUGE-L',
                            formatter: precentFormatter
                        }, {
                            field: 'bleu4ScoreP',
                            title: 'BLEU-4',
                            formatter: precentFormatter
                        }, {
                            field: 'commitDateP',
                            title: '提交日期'/*,
                        sortable: true*/
                        }
                    ],
                    data: data
                });

            },
            error: function (error) {
            }
        });
    }

    function precentFormatter(value) {
        return value.toFixed(2) + "%";
    }

    function linenumber(value, row, index) {
        let number = index + 1;
        if (number === 1) {
            number = "<img style='width: 30px;height:30px;'  src='../images/first.png' />"
        } else if (number === 2) {
            number = "<img style='width: 30px;height:30px;'  src='../images/second.png' />"
        } else if (number === 3) {
            number = "<img style='width: 30px;height:30px;'  src='../images/third.png' />"
        }
        return number;
    }

    function rowStyle(row, index) {
        let classes = ['success', 'info'];
        if (index < 10) {//前十行
            return {classes: classes[0]};
        }
        return {classes: ''};
    }

    //获取URL参数
    function getUrlParam(name) {
        let reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); // 构造一个含有目标参数的正则表达式对象
        let r = window.location.search.substr(1).match(reg);  // 匹配目标参数
        if (r != null) return unescape(r[2]); return null; // 返回参数值
    }
</script>
</body>

</html>

