<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>军事智能·机器阅读</title>
    <link href="../css/login.css" rel="stylesheet" type="text/css" />
    <link href="../css/header.css" rel="stylesheet" type="text/css" />
    <link href="../bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="../bootstrap-wizard/prettify.css" rel="stylesheet">

    <style>
        .rowLeft { margin-left: -23px; }
        @media (max-width:480px) {
            .rowLeft {
                margin-left: -15px;
            }
        }
    </style>

</head>

<body>
<header class="header fixed clearfix navbar navbar-fixed-top">
    <div class="container">
        <div class="row rowLeft">
            <div class="col-md-12">
                <div class="header-left">
                    <div class="logo smooth-scroll">
                        <a href="../index.html"><img id="logo" src="http://pb2edde5m.bkt.clouddn.com/logo2.png" alt="Worthy"></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
<div class="container">
    <div class="row">
        <div class="col-md-12 toTop">
            <div id="rootwizard">
                <div class="navbar">
                    <div class="navbar-inner">
                        <div class="container">
                            <ul>
                                <li><a href="#tab1" data-toggle="tab">基本信息验证</a></li>
                                <li><a href="#tab2" data-toggle="tab" id="modify">修改密码</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div id="bar" class="progress">
                    <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>
                </div>
                <div class="tab-content">
                    <div class="tab-pane col-md-12" id="tab1">
                        <div  class="col-md-3">

                        </div>
                        <form  class="form-horizontal col-md-6" style="padding: 50px 0;">
                            <div class="form-group">
                                <label class="control-label col-md-4 col-sm-4 col-xs-4" for="username" style="padding: 0;"><span class="required-flag">*</span>账号：</label>
                                <div class="controls col-md-8 col-sm-8 col-xs-8">
                                    <div style="border-radius: 4px;">
                                        <input id="username" class="form-control" type="text" />
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-4 col-sm-4 col-xs-4" for="capName" style="padding: 0;"><span class="required-flag">*</span>用户名：</label>
                                <div class="controls col-md-8 col-sm-8 col-xs-8">
                                    <div style="border-radius: 4px;">
                                        <input id="capName" class="form-control" type="text" />
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-4 col-sm-4 col-xs-4" for="tel" style="padding: 0;"><span class="required-flag">*</span>电话：</label>
                                <div class="controls col-md-8 col-sm-8 col-xs-8">
                                    <div style="border-radius: 4px;">
                                        <input id="tel" class="form-control" type="text" />
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-4 col-sm-4 col-xs-4" for="email" style="padding: 0;"><span class="required-flag">*</span>邮箱：</label>
                                <div class="controls col-md-8 col-sm-8 col-xs-8">
                                    <div style="border-radius: 4px;">
                                        <input id="email" class="form-control" type="text" />
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12 col-sm-12 col-xs-12 commit_btn_container" style="margin-top: 20px;">
                                <div class="col-md-5">

                                </div>
                                <button class="btn btn-primary col-md-4" type="button" onclick="validatePwd()">验证</button>
                            </div>
                            <br>
                        </form>
                        <div class="col-md-3">

                        </div>
                    </div>
                    <div class="tab-pane col-md-12" id="tab2">
                        <div  class="col-md-3">

                        </div>
                        <form  class="form-horizontal col-md-6" style="padding: 50px 0;"  autocomplete="off">
                            <div class="form-group">
                                <label class="control-label col-md-4 col-sm-4 col-xs-4" for="pwd1" style="padding: 0;"><span class="required-flag">*</span>密码：</label>
                                <div class="controls col-md-8 col-sm-8 col-xs-8">
                                    <div style="border-radius: 4px;">
                                        <input id="pwd1" class="form-control" type="password" autocomplete="off"/>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-4 col-sm-4 col-xs-4" for="pwd2" style="padding: 0;"><span class="required-flag">*</span>确认密码：</label>
                                <div class="controls col-md-8 col-sm-8 col-xs-8">
                                    <div style="border-radius: 4px;">
                                        <input id="pwd2" class="form-control" type="password"  autocomplete="off"/>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12 col-sm-12 col-xs-12 commit_btn_container" style="margin-top: 20px;">
                                <div class="col-md-5">

                                </div>
                                <button class="btn btn-primary col-md-4" type="button" onclick="changePwd()">修改</button>
                            </div>
                            <br>
                        </form>
                    </div>

                    <br>
                    <ul class="pager wizard">
                        <li class="previous first" style="display:none;"><a href="#">上一步</a></li>
                        <li class="previous"><a href="#">上一步</a></li>
                        <li class="next last" style="display:none;"><a href="#">完成</a></li>
                        <li class="next"><a href="#" id="nextA">下一步</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="http://code.jquery.com/jquery-latest.js"></script>
<script src="../js/cookie.js"></script>
<script src="../js/jquery.cookie.js"></script>
<script type="text/javascript" src="http://apps.bdimg.com/libs/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../js/jquery.base64.js"></script>
<script src="../js/globalIP.js"></script>
<script src="../bootstrap-wizard/jquery.bootstrap.wizard.js"></script>
<script src="../bootstrap-wizard/prettify.js"></script>
<script type="text/javascript">
    let ifValid = false;
    let count = 1;
    document.getElementById("modify").disabled = true;
    function CheckPassWord(password) {//必须为字母加数字且长度不小于8位
        let str = password;
        if (str == null || str.length <6) {
            return false;
        }
        let reg1 = new RegExp(/^[0-9A-Za-z]+$/);
        if (!reg1.test(str)) {
            return false;
        }
        let reg = new RegExp(/[A-Za-z].*[0-9]|[0-9].*[A-Za-z]/);
        if (reg.test(str)) {
            return true;
        } else {
            return false;
        }
    }

    function checkPwd2(){
        let isValidatePwd = false;
        let pwd1 = $("#pwd1").val();
        if(CheckPassWord(pwd1)){
            isValidatePwd = true;
        }else{
            alert("密码必须为字母与数字混合，且不小于6位");
            isValidatePwd = false;
        }
        return isValidatePwd;
    }

    $(document).ready(function() {
        $('#rootwizard').bootstrapWizard({onNext: function(tab, navigation, index) {
                count = index;
                if(index===1) {
                    // Make sure we entered the name
                    if(!ifValid) {
                        alert('请先验证基本信息');
                        document.getElementById("modify").disabled = true;
                        $('#username').focus();
                        return false;
                    }
                }

            }, onTabShow: function(tab, navigation, index) {
                count = index;
                let $total = navigation.find('li').length;
                let $current = index+1;
                let $percent = ($current/$total) * 100;
                $('#rootwizard .progress-bar').css({width:$percent+'%'});
                if($current === 2){
                    document.getElementById("nextA").style.background = "lightgrey";
                    document.getElementById("nextA").style.color = "#fff";
                }
                if(ifValid && $current === 1){
                    document.getElementById("nextA").style.background = "#5cb85c";
                    document.getElementById("nextA").style.color = "#fff";
                }
            }});
    });

    function validatePwd() {
        let username = $("#username").val();                     //账号
        let name = $("#capName").val();                       //姓名
        let telephoneNumber = $("#tel").val();             //电话
        let email = $("#email").val();                     //邮箱

        let formData = new FormData();
        formData.append("username", username);
        formData.append("name", name);
        formData.append("telephoneNumber", telephoneNumber);
        formData.append("email", email);

        $.ajax({
            url: IpAll() + "users/forgetpasswordcheck",
            data: formData,
            type: "POST",
            async: false,
            dataType: "json",
            cache: false,
            processData: false,
            contentType: false,
            enctype: 'multipart/form-data',
            timeout: 5000,
            success: function (result) {
                alert("验证通过...");
                ifValid = true;
                document.getElementById("modify").disabled = false;
                document.getElementById("nextA").style.background = "#5cb85c";
                document.getElementById("nextA").style.color = "#fff";
            },
            error: function (error) {
                let notifyMessage = error.responseJSON.message
                alert(notifyMessage)
            }
        });
    }

    function changePwd() {
        let username = $("#username").val();                     //账号
        let name = $("#capName").val();                       //姓名
        let telephoneNumber = $("#tel").val();             //电话
        let email = $("#email").val();
        let pwd1 = $("#pwd1").val();
        let pwd2 = $("#pwd2").val();


        if(checkPwd2()){
            if(pwd1 !== pwd2){
                alert("两次输入的密码不一致");
                return;
            }else {
                let formData = new FormData();
                formData.append("username", username);
                formData.append("name", name);
                formData.append("telephoneNumber", telephoneNumber);
                formData.append("email", email);
                formData.append("password", pwd1);

                $.ajax({
                    url: IpAll() + "users/forgetpassword",
                    data: formData,
                    type: "POST",
                    async: false,
                    dataType: "json",
                    cache: false,
                    processData: false,
                    contentType: false,
                    enctype: 'multipart/form-data',
                    timeout: 5000,
                    success: function (result) {
                        alert("修改成功...");
                        window.location.href = 'login.html';
                    },
                    error: function (error) {
                        let notifyMessage = error.responseJSON.message
                        alert(notifyMessage)
                    }
                });
            }
        }
    }

</script>
</body>
</html>
