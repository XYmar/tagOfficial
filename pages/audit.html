<!DOCTYPE html>
<html>
<head>
    <title>军事智能·机器阅读</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link href="http://apps.bdimg.com/libs/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../bootstrap-table/bootstrap-table.min.css">
    <link href="apply.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="../css/member.css">
    <link href="../css/header.css" rel="stylesheet" type="text/css" />
    <style>
        .rowLeft { margin-left: -23px; }
        .auditState {
            width: 70px !important;
        }
        @media (max-width:480px) {
            .rowLeft {
                margin-left: -15px;
            }
        }
    </style>
</head>

<body style="background-image: url('http://pb2edde5m.bkt.clouddn.com/bgPic.png');" id="showBody">
<header class="header fixed clearfix navbar navbar-fixed-top">
    <div class="container">
        <div class="row rowLeft">
            <div class="col-md-12">
                <div class="header-left">
                    <div class="logo smooth-scroll">
                        <a href="../index.html"><img id="logo" src="http://pb2edde5m.bkt.clouddn.com/logo2.png" alt="Worthy"></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<div class="container auditContainer">
    <div class="row main-content">
        <div class="col-md-12 toTop">
            <h3 class="title-main">
                管理员功能
            </h3>
            <div class="row">
                <hr>
                <div class="col-md-12 childToTop">
                    <div class="row-fluid col-md-12">
                        <div class="col-md-1 row-fluid">
                        </div>
                        <div class="col-md-11 col-xs-11 row-fluid">
                            <h3 class="message"><span class="required-flag">*</span>团队信息如下，可进行审核操作</h3>
                        </div>
                    </div>
                    <br>
                    <div class="row-fluid col-md-12" style="margin-top: 20px;">
                        <div class="col-md-1">
                        </div>
                        <div class="col-md-10 col-xs-12 row-fluid" style="padding: 0;">
                            <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
                                <div class="panel panel-default">
                                    <div class="panel-heading" role="tab" id="headingOne">
                                        <h4 class="panel-title">
                                            <a role="button" data-toggle="collapse" class="shenhea" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                                未审核
                                            </a>
                                            <span id="notAuditNum" style="margin-left:6px;"></span>
                                        </h4>
                                    </div>
                                    <div id="collapseOne" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">
                                        <div class="panel-body">
                                            <div id="NoAuditInfo" style="text-align: center">暂无数据</div>
                                            <div class="table-responsive" style="margin-top: -10px">
                                                <table id="memberInfoTableNotready">
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="panel panel-default">
                                    <div class="panel-heading" role="tab" id="headingTwo">
                                        <h4 class="panel-title">
                                            <a class="collapsed shenhea" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                                已审核
                                            </a>
                                            <span id="hasAuditNum" style="margin-left:6px;"></span>
                                        </h4>
                                    </div>
                                    <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
                                        <div class="panel-body">
                                            <div id="hasAuditInfo" style="text-align: center">暂无数据</div>
                                            <div class="table-responsive" style="margin-top: -10px">
                                                <table id="memberInfoTableAlready">
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-1">
                        </div>
                    </div>
                    <br>
                    <div class="row-fluid col-md-12">
                        <div class="col-md-1 row-fluid">
                        </div>
                        <div class="col-md-11 col-xs-11 row-fluid">
                            <h3 class="message" style="margin-top: 20px;"><span class="required-flag">*</span>排行榜如下</h3>
                        </div>
                    </div>
                    <!-- 成绩表格 -->
                    <div class="row-fluid col-md-12" style="margin-top: 10px;">
                        <div class="col-md-1">
                        </div>
                        <div class="col-md-10 col-xs-12 group-info" style="padding: 10px 10px;">

                            <!-- tab页开始 -->
                            <ul class="nav nav-tabs" role="tablist">
                                <li role="presentation" class="active"><a href="#trainingScoreInfo" aria-controls="home" role="tab" data-toggle="tab">训练成绩</a></li>
                                <li role="presentation"><a href="#preliminaryScoreInfo" aria-controls="profile" role="tab" data-toggle="tab">初赛成绩</a></li>
                                <li role="presentation"><a href="#finalScoreInfo" aria-controls="profile" role="tab" data-toggle="tab">决赛成绩</a></li>
                            </ul>

                            <!-- Tab panes -->
                            <div class="tab-content">
                                <div role="tabpanel" class="tab-pane active" id="trainingScoreInfo">
                                    <div class="col-md-12" style="padding: 0">
                                        <!--<table class="table table-bordered">
                                            <thead>
                                            <tr>
                                                <th>
                                                    BLEU_4
                                                </th>
                                                <th>
                                                    ROUGE
                                                </th>
                                                <th>
                                                    日期
                                                </th>
                                            </tr>
                                            </thead>
                                            <tbody id="TeamScore">
                                            </tbody>
                                        </table>-->
                                        <div>
                                            <table id="trainingScoreInfoTable">
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div role="tabpanel" class="tab-pane" id="preliminaryScoreInfo">
                                    <div class="col-md-12" style="padding: 0">
                                        <div>
                                            <table id="preliminaryScoreInfoTable">
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div role="tabpanel" class="tab-pane" id="finalScoreInfo">
                                    <div class="col-md-12" style="padding: 0">
                                        <div>
                                            <table id="finalScoreInfoTable">
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- tab页结束 -->

                        </div>
                        <div class="col-md-1">
                        </div>
                    </div>
                </div>
            </div>
            <br>
            <br>
        </div>
    </div>
</div>

<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script type="text/javascript" src="http://apps.bdimg.com/libs/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script src="../bootstrap-table/bootstrap-table.min.js"></script>
<script src="../bootstrap-table/bootstrap-table-zh-CN.min.js"></script>
<script src="../js/cookie.js"></script>
<script src="../js/jquery.cookie.js"></script>
<script type="text/javascript" src="../js/jquery.base64.js"></script>
<script src="../js/globalIP.js"></script>
<script type="text/javascript">
    let isTrainLoaded = false;
    let isPrimaryLoaded = false;
    let isFinalLoaded = false;

    window.onload=function(){
        let username = $.cookie("myUsername");
        let password0 = $.cookie("myWPa");
        let password = $.base64.decode(password0);
        let token = username + ':' + password;
        let role = $.cookie("myRole");
        if ((username != null) && (username !== "null")) {
            if(role === 'admin'){
                let datalistA = []
                let datalistB = []
                let dataAll = []

                // 获取未审核
                $.ajax({
                    type: "GET",
                    dataType: "json",
                    url: IpAll() + "users/byRoleName" ,
                    data: {rolename: 'user'},
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Authorization', 'Basic ' + btoa(token));
                    },
                    success: function (result) {
                        let data = result.data;
                        let dataLength = data.length
                        if(data.length !== 0){
                            //console.log(result.data);//打印服务端返回的数据(调试用)
                            let notAudit = document.getElementById('notAuditNum')
                            notAudit.innerHTML = '[' + dataLength + '条]'
                            document.getElementById('NoAuditInfo').innerHTML = ''
                            let noAuditTbody = document.getElementById("noAudit");
                            /*for (let i=0;i<data.length;i++) {
                                str += "<tr>" +
                                    "<td style='display:none'>" + data[i].id + "</td>" +
                                    "<td>" + data[i].teamName + "</td>" +
                                    "<td>" + data[i].name + "</td>" +
                                    "<td>" + data[i].age + "</td>" +
                                    "<td>" + (data[i].sex === 0 ? '男' : '女') + "</td>" +
                                    "<td>" + data[i].telephoneNumber + "</td>" +
                                    "<td>" + data[i].organization + "</td>" +
                                    "<td><a href='auditDetail.html?id=" + data[i].id + "' style='float: none;'>" +
                                    "<button class='btn btn-success btn-success editMember' type='button' >审核</button> " +
                                    "</a></td>" +
                                    "</tr>";
                            }
                            noAuditTbody.innerHTML = str;*/
                        }
                        $('#memberInfoTableNotready').bootstrapTable({
                            sidePagination : "client", // 分页方式：client客户端分页，server服务端分页（*）
                            pagination : true, // 是否显示分页（*）
                            pageNumber: 1,    //如果设置了分页，首页页码
                            pageSize: 10,                       //每页的记录行数（*）
                            pageList: [10,20,30],        //可供选择的每页的行数（*）
                            search:true,
                            columns: [{
                                field: 'teamName',
                                title: '组名'
                            }, {
                                field: 'name',
                                title: '姓名'
                            }, {
                                field: 'age',
                                title: '年龄'
                            },{
                                field: 'sex',
                                title: '性别',
                                formatter: sexFormatter
                            },{
                                field: 'telephoneNumber',
                                title: '手机号'
                            },{
                                field: 'organization',
                                title: '单位/学校'
                            },{
                                field: 'createTime',
                                title: '注册时间'
                            },{
                                field: 'id',
                                title: 'id',
                                visible: false
                            },{
                                field: 'createTime',
                                title: '注册时间',
                                sortable: true,
                                visible: false
                            },{
                                field: 'id',
                                title: '操作',
                                formatter: actionFormatter
                            }
                            ],
                            data: data
                        });
                    },
                    error : function() {
                        alert("请求错误！");
                    }
                });

                // 获取通过和未通过
                $.ajax({
                    type: "GET",
                    dataType: "json",
                    url: IpAll() + "users/byRoleName" ,
                    data: {rolename: 'accept'},
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Authorization', 'Basic ' + btoa(token));
                    },
                    success: function (result) {
                        datalistA = result.data;
                        // 获取审核未通过的信息
                        $.ajax({
                            type: "GET",
                            dataType: "json",
                            url: IpAll() + "users/byRoleName" ,
                            data: {rolename: 'denied'},
                            beforeSend: function (xhr) {
                                xhr.setRequestHeader('Authorization', 'Basic ' + btoa(token));
                            },
                            success: function (result) {
                                datalistB = result.data

                                // 拼接审核通过和未通过的数据
                                let dataAll = datalistA.concat(datalistB)
                                let dataLength = dataAll.length
                                if(datalistA.length !== 0){
                                    let hasAudit = document.getElementById('hasAuditNum')
                                    hasAudit.innerHTML = '['+ dataLength + '条]'
                                    document.getElementById('hasAuditInfo').innerHTML = ''
                                }

                                // 生成表格
                                $('#memberInfoTableAlready').bootstrapTable({
                                    sidePagination : "client", // 分页方式：client客户端分页，server服务端分页（*）
                                    pagination : true, // 是否显示分页（*）
                                    pageNumber: 1,    //如果设置了分页，首页页码
                                    pageSize: 10,                       //每页的记录行数（*）
                                    pageList: [10,20,30],        //可供选择的每页的行数（*）
                                    search:true,
                                    columns: [{
                                        field: 'teamName',
                                        title: '组名'
                                    }, {
                                        field: 'name',
                                        title: '姓名'
                                    }, {
                                        field: 'age',
                                        title: '年龄'
                                    },{
                                        field: 'sex',
                                        title: '性别',
                                        formatter: sexFormatter
                                    },{
                                        field: 'telephoneNumber',
                                        title: '手机号'
                                    },{
                                        field: 'organization',
                                        title: '单位/学校'
                                    },{
                                        field: 'createTime',
                                        title: '注册时间'
                                    },{
                                        field: 'id',
                                        title: 'id',
                                        visible: false
                                    },{
                                        field: 'authorities',
                                        title: '状态',
                                        class: 'auditState',
                                        formatter: statusFormatter
                                    },{
                                        field: 'id',
                                        title: '操作',
                                        formatter: actionFormatter2
                                    }
                                    ],
                                    data: dataAll
                                });
                            },
                            error : function() {
                                alert("请求错误！");
                            }
                        });
                    },
                    error : function() {
                        alert("请求错误！");
                    }
                });

                //生成性别
                function sexFormatter(value) {
                    let sexValue
                    if (value == 0 ) {
                        sexValue = '男'
                    }
                    else if (value == 1) {
                        sexValue = '女'
                    }
                    return sexValue
                }

                //生成操作
                function actionFormatter(value) {
                    return "<a href='auditDetail.html?id=" + value + "' style='float: none;'>" +
                        "<button class='btn btn-success btn-success editMember' type='button' >审核</button> " +
                        "</a>"
                }

                //生成操作
                function actionFormatter2(value) {
                    return "<a href='auditMemDetail.html?id=" + value + "' style='float: none;'>" +
                        "<button class='btn btn-success btn-success editMember' type='button' >详情</button> " +
                        "</a>"
                }

                //生成状态
                function statusFormatter(value) {
                    if(value[0].authority.indexOf('accept') > 0) {
                        return "<span style=\"color: #27A9E3;\">已通过</span>"
                    } else if(value[0].authority.indexOf('denied') > 0){
                        return "<span style=\"color: #ff0000;\">未通过</span>"
                    }
                }

                getTrainingScore({"init": 1});
                getPreliminaryScoreScore({"init": 1});
                getFinalScore({"init": 1});
            }else{
                document.getElementById("showBody").style.display = "none";
                window.location.href="../index.html";

            }
        }else{
            document.getElementById("showBody").style.display = "none";
            window.location.href="login.html";
        }
    }

    //训练成绩
    function getTrainingScore(opts){
        $.ajax({
            type: "GET",
            dataType: "json",
            data: { type: 0 },
            url: IpAll() + "users/ranking" ,
            beforeSend: function() {
                isTrainLoaded = false;
            },
            success: function (result) {
                let data = result.data;
                console.log(data);
                $("#trainingScoreInfoTable").bootstrapTable('destroy');
                $('#trainingScoreInfoTable').bootstrapTable({
                    sidePagination : "client", // 分页方式：client客户端分页，server服务端分页（*）
                    pagination : true, // 是否显示分页（*）
                    pageNumber: 1,    //如果设置了分页，首页页码
                    pageSize: 30,                       //每页的记录行数（*）
                    pageList: [30,40],        //可供选择的每页的行数（*）
                    search:true,
                    columns: [{
                        field: 'teamName',
                        title: '队伍名称'
                    },{
                        field: 'bleu4ScoreT',
                        title: 'BLEU-4',
                        formatter: precentFormatter
                    }, {
                        field: 'rougelScoreT',
                        title: 'ROUGE-L',
                        formatter: precentFormatter
                    },  {
                        field: 'createTime',
                        title: '提交日期',
                        sortable: true
                    }
                    ],
                    data: data
                });

            },
            complete: function() {
                isTrainLoaded = true;
            },
            error : function(error) {
                let notifyMessage = error.responseJSON.message
                alert(notifyMessage)
            }
        });
    }
    getTrainingScore({"init": 1});
    setInterval(function() {
        isTrainLoaded && getTrainingScore({"init": 0});
    }, 10000);

    //初赛成绩
    function getPreliminaryScoreScore(opts){
        $.ajax({
            type: "GET",
            dataType: "json",
            data: { type: 1 },
            url: IpAll() + "users/ranking" ,
            beforeSend: function() {
                isPrimaryLoaded = false;
            },
            success: function (result) {
                let data = result.data;
                console.log(data);
                $("#preliminaryScoreInfoTable").bootstrapTable('destroy');
                $('#preliminaryScoreInfoTable').bootstrapTable({
                    sidePagination : "client", // 分页方式：client客户端分页，server服务端分页（*）
                    pagination : true, // 是否显示分页（*）
                    pageNumber: 1,    //如果设置了分页，首页页码
                    pageSize: 30,                       //每页的记录行数（*）
                    pageList: [30,40],        //可供选择的每页的行数（*）
                    search:true,
                    columns: [{
                        field: 'teamName',
                        title: '队伍名称'
                    },{
                        field: 'bleu4ScoreP',
                        title: 'BLEU-4',
                        formatter: precentFormatter
                    }, {
                        field: 'rougelScoreP',
                        title: 'ROUGE-L',
                        formatter: precentFormatter
                    },  {
                        field: 'createTime',
                        title: '提交日期',
                        sortable: true
                    }
                    ],
                    data: data
                });

            },
            complete: function() {
                isPrimaryLoaded = true;
            },
            error : function(error) {
                let notifyMessage = error.responseJSON.message
                alert(notifyMessage)
            }
        });
    }
    getPreliminaryScoreScore({"init": 1});
    setInterval(function(opts) {
        isPrimaryLoaded && getPreliminaryScoreScore({"init": 0});
    }, 10000);

    //决赛成绩
    function getFinalScore(opts){
        $.ajax({
            type: "GET",
            dataType: "json",
            data: { type: 2 },
            url: IpAll() + "users/ranking" ,
            beforeSend: function() {
                isFinalLoaded = false;
            },
            success: function (result) {
                let data = result.data;
                console.log(data);
                $("#finalScoreInfoTable").bootstrapTable('destroy');
                $('#finalScoreInfoTable').bootstrapTable({
                    sidePagination : "client", // 分页方式：client客户端分页，server服务端分页（*）
                    pagination : true, // 是否显示分页（*）
                    pageNumber: 1,    //如果设置了分页，首页页码
                    pageSize: 30,                       //每页的记录行数（*）
                    pageList: [30,40],        //可供选择的每页的行数（*）
                    search:true,
                    columns: [{
                        field: 'teamName',
                        title: '队伍名称'
                    },{
                        field: 'bleu4ScoreF',
                        title: 'BLEU-4',
                        formatter: precentFormatter
                    }, {
                        field: 'rougelScoreF',
                        title: 'ROUGE-L',
                        formatter: precentFormatter
                    },  {
                        field: 'createTime',
                        title: '提交日期',
                        sortable: true
                    }
                    ],
                    data: data
                });

            },
            complete: function() {
                isFinalLoaded = true;
            },
            error : function(error) {
                let notifyMessage = error.responseJSON.message
                alert(notifyMessage)
            }
        });
    }
    getFinalScore({"init": 1});
    setInterval(function() {
        isFinalLoaded && getFinalScore({"init": 0});
    }, 10000);

    function precentFormatter(value) {
        return value.toFixed(2) + "%";
    }

</script>
</body>
</html>
